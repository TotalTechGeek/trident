# Recipe: Text File Generation

This recipe shows how to generate non-YAML/JSON files like nginx configs, INI files, and shell scripts.

## The `$text` Directive

Use `$text` to output raw text instead of structured data:

```yaml
$out: {{name}}/config.conf
$text: |
  [server]
  name = {{name}}
  port = {{port}}
  debug = {{#if debug}}true{{else}}false{{/if}}
```

## Nginx Configuration

### Project Structure

```
nginx-configs/
├── template.yaml
└── manifest.yaml
```

### Manifest

```yaml
# manifest.yaml
name: api
port: 8080
upstream_servers:
  - api-1:8080
  - api-2:8080
  - api-3:8080
ssl: true
---
name: web
port: 3000
upstream_servers:
  - web-1:3000
  - web-2:3000
ssl: true
---
name: admin
port: 9000
upstream_servers:
  - admin-1:9000
ssl: false
```

### Template

```yaml
# template.yaml
$out: sites-available/{{name}}.conf
$text: |
  upstream {{name}}_backend {
  {{#each upstream_servers}}
      server {{this}};
  {{/each}}
  }

  server {
  {{#if ssl}}
      listen 443 ssl;
      ssl_certificate /etc/ssl/certs/{{name}}.crt;
      ssl_certificate_key /etc/ssl/private/{{name}}.key;
  {{else}}
      listen 80;
  {{/if}}
      server_name {{name}}.example.com;

      location / {
          proxy_pass http://{{name}}_backend;
          proxy_set_header Host $host;
          proxy_set_header X-Real-IP $remote_addr;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
      }

      location /health {
          access_log off;
          return 200 '{"status": "healthy", "service": "{{name}}"}';
          add_header Content-Type application/json;
      }
  }
$replace:
  "$host": "$host"
  "$remote_addr": "$remote_addr"
  "$proxy_add_x_forwarded_for": "$proxy_add_x_forwarded_for"
  "$scheme": "$scheme"
```

Note: `$replace` preserves nginx variables that would otherwise be interpreted as Trident variables.

## INI Configuration Files

```yaml
# template.yaml
$out: {{name}}/app.ini
$text: |
  [application]
  name = {{name}}
  environment = {{environment}}
  debug = {{#if debug}}1{{else}}0{{/if}}

  [database]
  host = {{database.host}}
  port = {{database.port}}
  name = {{database.name}}
  pool_size = {{default database.pool_size 5}}

  [logging]
  level = {{default logging.level "INFO"}}
  format = {{default logging.format "%(asctime)s - %(name)s - %(levelname)s - %(message)s"}}

  {{#if redis}}
  [redis]
  host = {{redis.host}}
  port = {{default redis.port 6379}}
  {{/if}}
```

## Shell Scripts

```yaml
# template.yaml
$out: scripts/deploy-{{name}}.sh
$text: |
  #!/bin/bash
  set -euo pipefail

  # Deploy {{name}} service
  # Generated by Trident - DO NOT EDIT

  SERVICE_NAME="{{name}}"
  IMAGE="{{image}}"
  REPLICAS={{replicas}}

  echo "Deploying $SERVICE_NAME..."

  {{#if pre_deploy_commands}}
  # Pre-deploy commands
  {{#each pre_deploy_commands}}
  {{this}}
  {{/each}}
  {{/if}}

  # Apply Kubernetes manifests
  kubectl apply -f ./{{name}}/

  # Wait for rollout
  kubectl rollout status deployment/$SERVICE_NAME --timeout=300s

  {{#if post_deploy_commands}}
  # Post-deploy commands
  {{#each post_deploy_commands}}
  {{this}}
  {{/each}}
  {{/if}}

  echo "Successfully deployed $SERVICE_NAME"
```

## Docker Compose Files

```yaml
# template.yaml
$out: docker-compose.{{environment}}.yaml
$text: |
  version: '3.8'

  services:
  {{#each services}}
    {{this.name}}:
      image: {{this.image}}
      {{#if this.ports}}
      ports:
      {{#each this.ports}}
        - "{{this}}"
      {{/each}}
      {{/if}}
      {{#if this.environment}}
      environment:
      {{#each this.environment}}
        {{@key}}: "{{this}}"
      {{/each}}
      {{/if}}
      {{#if this.depends_on}}
      depends_on:
      {{#each this.depends_on}}
        - {{this}}
      {{/each}}
      {{/if}}

  {{/each}}
```

## Environment Files

```yaml
# template.yaml
$out: {{name}}/.env
$text: |
  # Environment configuration for {{name}}
  # Generated by Trident

  SERVICE_NAME={{name}}
  ENVIRONMENT={{environment}}
  {{#each env}}
  {{@key}}={{this}}
  {{/each}}
```

## Systemd Unit Files

```yaml
# template.yaml
$out: {{name}}.service
$text: |
  [Unit]
  Description={{description}}
  After=network.target
  {{#if dependencies}}
  Requires={{#each dependencies}}{{this}}.service {{/each}}
  {{/if}}

  [Service]
  Type={{default type "simple"}}
  User={{default user "app"}}
  Group={{default group "app"}}
  WorkingDirectory={{working_directory}}
  ExecStart={{exec_start}}
  {{#if exec_stop}}
  ExecStop={{exec_stop}}
  {{/if}}
  Restart={{default restart "on-failure"}}
  RestartSec={{default restart_sec 5}}

  {{#each environment}}
  Environment="{{@key}}={{this}}"
  {{/each}}

  [Install]
  WantedBy=multi-user.target
```

## Apache Virtual Host

```yaml
# template.yaml
$out: sites-available/{{name}}.conf
$text: |
  <VirtualHost *:{{default port 80}}>
      ServerName {{domain}}
      {{#if aliases}}
      ServerAlias {{#each aliases}}{{this}} {{/each}}
      {{/if}}

      DocumentRoot {{document_root}}

      <Directory {{document_root}}>
          Options -Indexes +FollowSymLinks
          AllowOverride All
          Require all granted
      </Directory>

      {{#if proxy_pass}}
      ProxyPreserveHost On
      ProxyPass / {{proxy_pass}}/
      ProxyPassReverse / {{proxy_pass}}/
      {{/if}}

      ErrorLog ${APACHE_LOG_DIR}/{{name}}-error.log
      CustomLog ${APACHE_LOG_DIR}/{{name}}-access.log combined
  </VirtualHost>
$replace:
  "${APACHE_LOG_DIR}": "${APACHE_LOG_DIR}"
```

## Tips for Text Generation

### 1. Use `|` for Multiline Strings

```yaml
$text: |
  Line 1
  Line 2
```

### 2. Use `>-` to Fold Lines

```yaml
$text: >-
  This is a long line that
  will be joined into
  a single line without newlines.
```

### 3. Preserve Special Characters with `$replace`

```yaml
$text: |
  echo $HOME
$replace:
  "$HOME": "$HOME"
```

### 4. Conditional Sections

```yaml
$text: |
  {{#if feature_enabled}}
  [feature]
  enabled = true
  {{/if}}
```

### 5. Loop Over Items

```yaml
$text: |
  {{#each items}}
  item_{{@index}} = {{this}}
  {{/each}}
```

## See Also

- [Templates and Manifests Guide](../guides/01-templates-and-manifests.md)
- [Handlebars Templating Guide](../guides/03-handlebars-templating.md)
